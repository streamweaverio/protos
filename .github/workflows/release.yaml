name: Release

on:
  push:
    tags:
      - '*'

run-name: Release ${{ github.ref }}

env:
  GO_PACKAGE: github.com/streamweaverio/go-protos
  OUTPUT_PATH: ./outputs/protos

jobs:
  go:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.23

      - name: Install Protoc
        uses: arduino/setup-protoc@v3

      - name: Install protoc-gen-go
        run: |
          # Install protoc-gen-go and protoc-gen-go-grpc
          go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2.0
          
          # Ensure GOPATH/bin is in the PATH
          echo "${HOME}/go/bin" >> $GITHUB_PATH

      - name: Git
        env:
          WORKING_DIRECTORY: "${{ env.OUTPUT_PATH }}/${{ env.GO_PACKAGE }}"
          PAT: ${{ secrets.WORKFLOW_GITHUB_PAT }}
          REPO: ${{ env.GO_PACKAGE }}
        run: |
          mkdir -p $WORKING_DIRECTORY
          cd $WORKING_DIRECTORY
          git config --global user.name "Streamweaver Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch main
          git init
          git remote add origin https://x-access-token:$PAT@$REPO
          git pull origin main --allow-unrelated-histories

      - name: Generate Go Code
        run: |
          make gen_go
          make package_go

      - name: Commit Go Code
        id: commit
        env:
          WORKING_DIRECTORY: "${{ env.OUTPUT_PATH }}/${{ env.GO_PACKAGE }}"
        run: |
          GIT_SHORT_SHA=$(git rev-parse --short HEAD)
          COMMIT_SHA=$(git rev-parse HEAD)
          VERSION=$(echo ${{ github.ref }} | cut -d'/' -f 3)

          cd $WORKING_DIRECTORY
          BRANCH="protos-$(date +'%Y%m%d')-$GIT_SHORT_SHA"
          git status
          git switch -c $BRANCH
          git add .
          git commit -m "Streamweaver proto $VERSION: Generated Go code from commit: $COMMIT_SHA"
          git push origin $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: pull_request
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_GITHUB_PAT }}
          BRANCH: ${{ steps.commit.outputs.branch }}
          TARGET_BRANCH: main
          COMMIT_SHA: $(git rev-parse HEAD)
          PR_BODY: |
            This PR was automatically generated by the Streamweaver Bot.
        run: |
          echo "Creating pull request..."
          TITLE="Streamweaver proto: Generated Go code from commit: $COMMIT_SHA"
          pr_url=$(gh pr create -B $TARGET_BRANCH -H $BRANCH --title "$TITLE" --body "$PR_BODY" --label "automerge")
          pr_number=$(echo $pr_url | grep -oP '(?<=pull/)\d+')
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

      - name: Merge Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_GITHUB_PAT }}
          PR_NUMBER: ${{ steps.pull_request.outputs.pr_number }}
        run: |
          echo "Waiting for PR to be ready..."
          sleep 30  # Adjust the sleep duration if necessary
          echo "Merging PR..."
          gh pr merge $PR_NUMBER -s --admin --body "Auto-merging PR"
          